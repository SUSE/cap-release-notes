// Start attribute entry list (Do not edit here! Edit in entities.adoc)
ifdef::env-github[]
:suse: SUSE
:product: {suse} Cloud Application Platform
:version: 1.2
:rn-url: https://www.suse.com/releasenotes
:doc-url: https://www.suse.com/documentation/cloud-application-platform-1
:deployment-url: https://www.suse.com/documentation/cloud-application-platform-1/book_cap_deployment/data/book_cap_deployment.html
:caasp: {suse} Containers as a Service Platform
:caaspa: {suse} CaaS Platform
:ostack: OpenStack
:cf: Cloud Foundry
:scc: {suse} Customer Center
:azure: Microsoft Azure
:mysql: MySQL
:postgre: PostgreSQL
endif::[]
// End attribute entry list


[id='sec.major-change']
== Major Changes

[id='sec.1_2_1']
=== Release 1.2.1, September 2018

[id='sec.1_2_1.issue']
==== Known Issues

* If you are upgrading to {product} 1.2.1, you will need to run the `helm upgrade` command with two additional parameters: `helm upgrade --force --recreate-pods`. This will be the case with all future 1.x upgrades due to the expected behaviour with Kubernetes that unready pods won’t get upgraded.

* Similar to {caaspa} 3, {azure} now mandates a stricter security policy via PodSecurityPolicy (PSP), which is included as part the {product} Deployment Guide. Any namespace tied to {product} requires privileged ports to be accessible needs to have to have a PSP set appropriately for access. This would include the default conventions of `scf`, `uaa`, `stratos-ui`, `mysql-sidecar` and `postgres-sidecar` as per our documentation.

* {azure} users who previously had a Kubernetes policy without RBAC, but now have AKS with RBAC (which is the new default with AKS), will need to modify their `scf-config-values.yaml` files so that `auth: rbac` replaces `auth: none`. If you remain in an AKS policy without RBAC, then you can ignore this change.

* {azure} users will need to add `--node-osdisk-size=60` as part of their AKS creation command to ensure the root partition has enough space for the install and future upgrades. The {product} _Deployment Guide_ has a section called `Create Resource Group and AKS Instance` and the `node-osdisk-size` parameter would need to be added to the `az aks create` command. For more information about deploying {product}, see the _Deployment Guide_ at {deployment-url}.


[id='sec.1_2_1.feature']
==== Features and Fixes
* Introduction of App-autoscaler (off by default)
* Introduction of Minibroker for Redis 
* Support for Azure service brokers
* Cloud Foundry deployment bumped to 2.7.0
* `Groot-btrfs` now available
* HA for `nfs-broker`, `cc-clock` and `syslog-scheduler` roles
* Enabled cloud controller security events
* Exposed `broker_client_timeout_seconds` as a router parameter
* Realigned cf role composition to be more inline with upstream, which includes these changes:
** `mysql-proxy` has been merged into the `mysql` role
** `diego-locket` has been merged into `diego-api`
** `log-api` roles now combines `loggregator` and `syslog-rlp` 
** `syslog-adapter` renamed as `adapter`
* Removed processes list from all roles
* Removed duplicate `routing_api.locket.api_location` property
* `syslog-adapter` added to syslog adapter cert
* `INTERNAL_CA_KEY` not included in every pod by default
* Better mechanism for waiting on `mysql` included
* Includes these CF component versions:
** UAA: v60.2
** cf-deployment: 2.7.0
** ruby-buildpack: 1.7.21.1
** go-buildpack: 1.8.22.1
** kubectl: 1.9.6
** capi-release: 1.61.0
** cflinuxfs2-release: v1.227.0
** cf-mysql-release: v36.15.0
** cf-opensuse42-release: 648e8f1
** cf-sle12-release: c585efc
** cf-smoke-tests-release: 40.0.5
** cf-syslog-drain-release: v7.0
** cf-usb: 7a45076
** consul-release: v195
** diego-release: v2.12.1
** garden-runc-release:  v1.15.1
** loggregator-release: v103.0
** nats-release: v24
** nfs-volume-release: v1.2.0
** postgres-release: v26
** routing-release: 0.179.0
** scf-helper-release: b276460
** cf-acceptance-tests: c83c97b9
** testbrain: 1.0.0-61-ga172cf9
** statsd-injector-release: v1.3.0
** uaa-fissile-release: 0.0.1-299-gdd37ec6
* Buildpacks:
** binary-buildpack-release: 1.0.17
** dotnet-core-buildpack-release: 1.0.26-14-gf951834
** go-buildpack-release: 1.7.19-21-g0897183
** java-buildpack-release: 3.16-18-gfeab2b6
** nodejs-buildpack-release: 1.5.30-13-g584d686
** php-buildpack-release: 3dc85f9
** python-buildpack-release: 1.5.16-14-ga2bbb4c
** ruby-buildpack-release: bd1f612
** staticfile-buildpack-release: 1.4.0-12-gdfc6c09

[id='sec.1_2']
=== Release 1.2, August 2018

[id='sec.1_2.issue']
==== Known Issues

* Upgrading to {product} 1.2 introduces a new active/passive model that will result in a longer-than-usual app instance downtime for upgrades to this new version. As part of this change, you will need to run the `helm upgrade` command with two additional parameters: `helm upgrade --force --recreate-pods`. This will be noticeable when seeing Kubernetes pods marked as Unready. It is expected behaviour with Kubernetes that unready pods won’t get upgraded.

* {caaspa} 3 uses an updated version of Kubernetes that mandates a stricter security policy via PodSecurityPolicy (PSP), which is included as part the {product} Deployment Guide. This was optional in {caaspa} 2 but it works the same. Any namespace tied to {product} requires privileged ports to be accessible needs to have to have a PSP set appropriately for access. This would include the default conventions of `scf`, `uaa`, `stratos-ui`, `mysql-sidecar` and `postgres-sidecar` as per our documentation.

* UAA should be left as single availability and not high availability (HA)

[id='sec.1_2.feature']
==== Features and Fixes
* Support for Amazon EKS and {caaspa} v3
* Updated Stratos UI to v2
* Support for Azure load balancer enabled
* Updated backup/restore plugin (v1.0.8)
* New active/passive role management for pods whereby the past model of using Ready and Not Ready as states has been retired. Pods will now be labeled as Active or Passive and rely on stateful sets to be managed, allowing for more high availability. Details available here: https://github.com/SUSE/fissile/wiki/Pod-Management-using-Role-Manifest-Tags
* All roles aside from UAA can now be HA
* Certificate expiration now configurable
* Added support for manual rotation of cloud controller database keys
* Exposed the `router.client_cert_validation` property on the router
* Use namespace for helm install name
* Updated the role manifest validation to let the secrets generator use `KUBE_SERVICE_DOMAIN_SUFFIX` without having to configure HA itself
* `SCF_LOG_PORT` now set to default port of 514
* Fixed an issue during upgrade whereby USB sidecars did not receive updated password info, ensuring they will properly communicate with previously registered services
* Patched an issue with the timestamp for monit_rsyslogd
* `cf-backup-restore` restores security groups properly now
* `cf-backup-restore` now relies on statically linked Linux binaries
* Includes these CF component versions:
** UAA: v59
** cf-deployment: 1.36
** ruby-buildpack: 1.7.18.2
** go-buildpack: 1.8.22.1
** kubectl: 1.8.2
** capi-release: 1.58.0
** cflinuxfs2-release: v1.209.0
** cf-mysql-release: v36.14.0
** cf-opensuse42-release: 054a0ca
** cf-sle12-release: faf946c
** cf-smoke-tests-release: 40.0.5
** cf-syslog-drain-release: v6.5
** cf-usb: 7a45076
** consul-release: v192
** diego-release: v2.8.0-24-gad85f06a
** garden-runc-release:  v1.11.1
** loggregator-release: v102.1
** nats-release: v24
** nfs-volume-release: v1.2.0
** postgres-release: v26
** routing-release: 0.178.0
** scf-helper-release: b276460
** cf-acceptance-tests: 22c36ddc
** testbrain: 1.0.0-61-ga172cf9
** statsd-injector-release: v1.3.0
** uaa-fissile-release: 0.0.1-289-g571836a
* Buildpacks:
** binary-buildpack-release: 1.0.17
** dotnet-core-buildpack-release: 1.0.26-14-gf951834
** go-buildpack-release: 1.7.19-17-g9dbf944
** java-buildpack-release: 3.16-18-gfeab2b6
** nodejs-buildpack-release: 1.5.30-13-g584d686
** php-buildpack-release: 3dc85f9
** python-buildpack-release: 1.5.16-14-ga2bbb4c
** ruby-buildpack-release: ffffb58
** staticfile-buildpack-release: 1.4.0-12-gdfc6c09


[id='sec.1_1_1']
=== Release 1.1.1, May 2018

[id='sec.1_1_1.issue']
==== Known Issues

* Upgrading now rotates all internal passwords and certificates which may cause some downtime (e.g. users will be unable to push applications) as the roles are restarted. This should not impact the availability of hosted applications running multiple instances. 

* If you are using the bundled UAA release, upgrade this first and pass the new certificate to the SCF upgrade command as per the upgrade instructions below.

* When upgrading, existing deployments of the `cf-usb-sidecar-mysql` or `cf-usb-sidecar-postgres` brokers may subsequently be unable to delete service instances. The following commands fix this problem by updating the internal cf-usb password:

+
[source]
----
CF_NAMESPACE=scf
SECRET=$(kubectl get --namespace $CF_NAMESPACE deploy -o json \
  | jq -r '[.items[].spec.template.spec.containers[].env[] \
  | select(.name == "INTERNAL_CA_CERT").valueFrom.secretKeyRef.name] \
  | unique[]')
USB_PASSWORD=$(kubectl get -n scf secret $SECRET -o jsonpath='{@.data.cf-usb-password}' \
  | base64 -d)
USB_ENDPOINT=$(cf curl /v2/service_brokers \
  | jq -r '.resources[] | select(.entity.name=="usb").entity.broker_url')
cf update-service-broker usb broker-admin "$USB_PASSWORD" "$USB_ENDPOINT"
----

* If after upgrading:
** the `diego-api` role is not fully functional (i.e. appearing as `(0/1)`)
** the `bbs` job in the pod is not starting (as per `monit summary`)
** the bbs stdout log `/var/vcap/sys/log/bbs/bbs.stdout.log` contains _Error 1062: Duplicate entry 'version' for key 'PRIMARY'_
+
Do the following to unblock the upgrade:
** `kubectl exec` into (one of) the mysql pod(s)
+
----
kubectl exec -it mysql-0 --namespace cf -- env TERM=xterm /bin/bash
----
** Use `mysql` to connect to the diego database
+
----
mysql --defaults-file=/var/vcap/jobs/mysql/config/mylogin.cnf diego
----
** Remove the offending entry
+
----
DELETE FROM configurations WHERE id='version';
----

* Do not set the `mysql-proxy`, `routing-api`, `tcp-router`, `blobstore` or
`diego_access` roles to more than one instance each. Doing so can cause problems
with subsequent upgrades which could lead to loss of data. Scalability of these
roles will be enabled in an upcoming maintenance release.
* The `diego-api`, `diego-brain` and `routing-api` roles are configured as
active/passive, and passive pods can appear as _Not Ready_. This is expected
behavior.
* Azure operators may not be able to connect to Azure Database for
{mysql}/{postgre} databases with the current brokers.


[id='sec.1_1_1.feature']
==== Features and Fixes

* Enabled `router.forwarded_client_cert` variable for router
* New syslog roles can have anti-affinity
* {mysql}-proxy healthcheck timeouts are configurable 
* cfdot added to all diego roles
* Removed time stamp check for rsyslog
* Upgrades will handle certificates better by having the required SAN metadata
* Rotatable secrets are now immutable
* Immutable config variables will not be generated
* For high availability (HA) configurations, upgrades no longer require the `api` role to be scaled down
* `cf-backup-restore` handles Docker apps properly now
* `cf-backup-restore` returns a useful error if invalid JSON is parsed 
* PHP buildpack has been bumped to v.4.3.53.1 address MS-ISAC ADVISORY NUMBER 2018-046
* Updated sidecars for {mysql} and {postgre}

* Includes these CF component versions:
** uaa v56.0
** cf-deployment v.1.21
** loggregator-release v102.1
** cf-opensuse42-release 459ef9f
** cf-syslog-drain-release v6.0
** cf-usb 79b1a8c
** cf-mysql-release v36.11.0
** routing-release 0.174.0
** cf-sle12-release b96cbc2
** diego-release v2.1.0
** uaa-fissile-release 0.0.1-243-ge11bf8d
** cflinuxfs2-release v1.194.0
** cf-smoke-tests-release 40.0.1
** nats-release v23
** scf-helper-release/src/github.com/cloudfoundry/cf-acceptance-tests 3beb6ed
** capi-release 1.52.0


[id='sec.1_1']
=== Release 1.1, April 2018


[id='sec.1_1.new']
==== What Is New?

* Now supported on Microsoft Azure Container Services (AKS)
* Cloud Foundry component and buildpack updates (see <<sec.1_1.feature>>)
* {postgre} and {mysql} service broker sidecars, configured and deployed via Helm
* cf backup+ CLI plugin for saving, restoring, or migrating CF data and
applications

For more information about deploying {product}, see the _Deployment Guide_ at
{deployment-url}.


[id='sec.1_1.configuration']
==== Configuration Changes

Changes to the format of `values.yaml` for SCF and UAA require
special handling when upgrading from {product} 1.0 to 1.1 if you are reusing
configuration files (e.g. `scf-config-values.yaml`):

* All secrets formerly set under `env:` are now set under `secrets:`.
Any `_PASSWORD`, `_SECRET`, `_CERT`, or `_KEY` value explicitly set in
`values.yaml` for {product} 1.0 should be moved into the `secrets:` section
before running `helm upgrade` with the revised `values.yaml`. Find a sample
configuration in <<app.secret-sample>>.

* **These secrets must be resupplied on each upgrade** (for example, the
`CLUSTER_ADMIN_PASSWORD`, `UAA_ADMIN_CLIENT_SECRET`) as they will not be carried
forward automatically. We recommend always using a values file.

* To rotate secrets, increment the `kube.secrets_generation_counter`
(immutable generated secrets will not be reset).

* The `kube.external_ip` variable has been changed to `kube.external_ips`,
allowing for services to be exposed on multiple Kubernetes worker nodes (for
example, behind a TCP load balancer). Before upgrading, change the setting or
add a new setting specified as an array. For example:
+
----
kube.external_ip=10.1.1.1
kube.external_ips=["10.1.1.1"]
----

* Both variables can exist at the same time and be set to the same value for
those in mixed version environments. To specify multiple addresses, use:
+
[source]
----
kube.external_ips=["1.1.1.1", "2.2.2.2"]
----

* Upgrading from {product} 1.0.1 to 1.1
+
An example `scf-config-values.yaml` for {product} 1.1 would look like this:
+
[source,yaml]
----
env:
    # Domain for SCF. DNS for *.DOMAIN must point to a kube node's (not master)
    # external ip address.
    DOMAIN: cf-dev.io

kube:
    # The IP address assigned to the kube node pointed to by the domain.
    #### the external_ip setting changed to accept a list of IPs, and was
    #### renamed to external_ips
    external_ips: ["192.168.77.77"]
    storage_class:
        # Make sure to change the value in here to whatever storage class you use
        persistent: "persistent"
        shared: "shared"

    # The registry the images will be fetched from. The values below should work for
    # a default installation from the suse registry.
    registry:
       hostname: "registry.suse.com"
       username: ""
       password: ""
    organization: "cap"

    auth: rbac

secrets:
    # Password for user 'admin' in the cluster
    CLUSTER_ADMIN_PASSWORD: changeme

    # Password for SCF to authenticate with UAA
    UAA_ADMIN_CLIENT_SECRET: uaa-admin-client-secret
----
+
To upgrade from {product} 1.0.1 to 1.1, run the following commands:
+
[source,bash]
----
$ helm repo update
$ helm upgrade --recreate-pods <uaa-helm-release-name> suse/uaa --values scf-config-values.yaml
$ SECRET=$(kubectl get pods --namespace uaa -o jsonpath='{.items[*].spec.containers[?(.name=="uaa")].env[?(.name=="INTERNAL_CA_CERT")].valueFrom.secretKeyRef.name}')
$ CA_CERT="$(kubectl get secret $SECRET --namespace uaa -o jsonpath="{.data['internal-ca-cert']}" | base64 --decode -)"
$ helm upgrade --recreate-pods <scf-helm-release-name> suse/cf --values scf-config-values.yaml --set "secrets.UAA_CA_CERT=${CA_CERT}"
$ helm upgrade --recreate-pods <console-helm-release-name> suse/console --values scf-config-values.yaml
----


[id='sec.1_1.issue']
==== Known Issues

* Do not set the `mysql-proxy`, `routing-api`, `tcp-router`, `blobstore` or
`diego_access` roles to more than one instance each. Doing so can cause problems
with subsequent upgrades which could lead to loss of data. Scalability of these
roles will be enabled in an upcoming maintenance release.
* To upgrade high availability (HA) configurations, scale down the `api`
role count to 1. Then upon completing the upgrade, scale `api` up again to
2 or more.
** The `diego-api`, `diego-brain` and `routing-api` roles are configured as
active/passive, and passive pods can appear as _Not Ready_. This is expected
behavior.
* Azure operators may not be able to connect to Azure Database for
{mysql}/{postgre} databases with the current brokers.
* `cf backup-restore` may leave Docker apps in a stopped state. These can be
started manually.
* `cf backup-restore` produces an unhelpful error if the file is not valid JSON.


[id='sec.1_1.feature']
==== Features and Fixes

* Ability to specify multiple external IP addresses (please see <<sec.issue>>
  below on impact to upgrades)
* {mysql} now a clustered role
* {mysql}-proxy enabled for UAA
* UAA has more logging enabled, so `SCF_LOG_HOST`, `SCF_LOG_PORT` and
  `SCF_LOG_PROTOCOL` have been exposed
* TCP routing ports are configurable and can be templatized
* CPU limits can be set for pods.
* Memory limits for pods now properly enforced.
* Kubernetes annotations enabled so operators can specify what nodes
  particular roles can be run on
* Fixed cloud controller clock so that it will wait until API is ready
* Overhauled secret rotation for upgrades

* Includes these CF component versions:
** diego-release 1.35
** cf-mysql-release 36.10.0
** cflinuxfs2-release 1.187.0
** routing-release 0.172.0
** garden-runc-release 1.11.1
** nats-release 22
** capi-release 1.49.0

* Includes these {cf} buildpack versions:
** go-buildpack-release 1.7.19-16-g37cc6b4
** binary-buildpack-release 1.0.17
** nodejs-buildpack-release 1.5.30-13-g584d686
** ruby-buildpack-release 9adff61
** php-buildpack-release ea8acd0
** python-buildpack-release 1.5.16-14-ga2bbb4c
** staticfile-buildpack-release 1.4.0-12-gdfc6c09
** dotnet-core-buildpack-release 1.0.26-14-gf951834
** java-buildpack-release 3.16-18-gfeab2b6


[id='sec.1_0_1']
=== Release 1.0.1, February 2018

* Using the `helm upgrade` command in {product} 1.0 to 1.0.1 (scf 2.6.11 to
  2.7.0) requires the use of `--force` to drop an unnecessary persistent
  volume. Note that `helm upgrade` only works for multi-node clusters when
  running with a proper HA storage class. For example, `hostpath` will not
  work, as required stateful data can be lost.
* Bump to {cf} Deployment (1.9.0), using {cf} Deployment not {cf} Release
  from now on
* Bump UAA to v53.3
* Add ability to rename immutable secrets
* Update CATS to be closer to what upstream is using
* Make RBAC the default in the values.yaml (no need to specify anymore)
* Increase test brain timeouts to stop randomly failing tests
* Remove unused SANs from the generated TLS certificates
* Remove the dependency on jq from stemcells
* Fix duplicate buildpack ids when starting {cf}
* Fix an issue in the vagrant box where compilation would fail due to old
  versions of docker.
* Fix an issue where diego cell could not be mounted on NFS-backed Kubernetes
  storage class
* Fix an issue where diego cell could not mount NFS in persi
* Fix several problems reported with the syslog forwarding implementation


[id='sec.1_0']
=== Release 1.0, January 2018

* Initial product release
