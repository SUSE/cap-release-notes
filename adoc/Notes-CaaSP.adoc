// Start attribute entry list (Do not edit here! Edit in entities.adoc)
ifdef::env-github[]
:suse: SUSE
:product: {suse} Cloud Applications Platform
:version: 1.1
:rn-url: https://www.suse.com/releasenotes
:doc-url: https://www.suse.com/documentation/cloud-application-platform-1
:deployment-url: https://www.suse.com/documentation/cloud-application-platform-1/book_cap_deployment/data/book_cap_deployment.html
:caasp: {suse} Containers as a Service Platform
:caaspa: {suse} CaaS Platform
:ostack: OpenStack
:cf: Cloud Foundry
:scc: {suse} Customer Center
:azure: Microsoft Azure
:mysql: MySQL
:postgre: PostgreSQL
endif::[]
// End attribute entry list

[id='sec.caasp']
== Installing {product} on {caasp}

Prerequisite for deploying {cap} is a working installation of Kubernetes. {caasp} is one way to provide that.

For general instructions of how to install {caasp} see the https://www.suse.com/documentation/suse-caasp/index.html[{caasp} documentation].

Once you have a working installation of {caasp} follow the instructions in the https://www.suse.com/documentation/cloud-application-platform-1/book_cap_deployment/data/book_cap_deployment.html[{cap} manual] to deploy {cap}.

The following sections describe one way to get {caasp} deployed on OpenStack so that it is prepared for the deployment of {cap}.

[id='sec.caasp.openstack']
=== Deploying {caaspa} on {ostack} with Terraform


There are {ostack} images of {caaspa} which can be used to create a
Kubernetes cluster running on top of {ostack}.


[id='sec.caasp.consider-deploy']
==== Considerations Before Deploying

* This Guide is for setting up development/test installations with one master
  and two workers. It is intended as a installation example and will not
  result in a production system.

* This guide is valid for SUSE-CaaS-Platform-2.0 Version 1.0.0-GM. It will
  not work for older releases and might work for newer ones.

* Provide enough disk space for images

NOTE: The default is to provide 40Â GB of disk space to the {caaspa} nodes.
This is not sufficient for {product}. So use a machine flavor with a bigger disk
and let it use the additional free space for storing images.
For information about resizing the root file system of the {caaspa} node, see
<<sec.caasp.root-file-system>>.


[id='sec.caasp.prepare']
==== Initial preparations

The following steps only have to be done once before the initial {caaspa}
deployment. For following deployments of {caaspa} this has no to be redone
but already created elements can be reused. The deployment of {caaspa} on
{ostack} is done using existing Terraform rules with some additional steps
required for running {product} on the {caaspa} deployment.


* Start with downloading and sourcing the openrc.sh file for {ostack} API access
+
[source,bash]
----
$ firefox https://$OPENSTACK/project/access_and_security/api_access/openrc/
. openrc.sh
----

NOTE: You need to log in to download the file. The file name might have a
prefix named after the {ostack} project the file is for.


[id='sec.caasp.prepare-optional']
===== Optional Steps

These steps can be performed but are not mandatory. You can also use already
existing {ostack} objects instead. For example, if you do not have the
permission to create projects or networks).

. Create an {ostack} project to run {caaspa} in (for example, `caasp`), add a
user as admin and export the project to be used by Terraform:
+
[source,bash]
----
$ openstack project create --domain default --description "CaaS Platform Project" caasp
$ openstack role add --project caasp --user admin admin
$ export OS_PROJECT_NAME='caasp'
----

. Create a {ostack} network plus a subnet for caasp (for example,
`caasp-net`) and add a router to the external (for example, floating) network:
+
[source,bash]
----
$ openstack network create caasp-net
$ openstack subnet create caasp_subnet --network caasp-net --subnet-range 10.0.2.0/24
$ openstack router create caasp-net-router
$ openstack router set caasp-net-router --external-gateway floating
$ openstack router add subnet caasp-net-router caasp_subnet
----

[id='sec.caasp.prepare-mandatory']
===== Mandatory Steps

The following steps have to be performed at least once to be able to deploy
{caaspa} and {product} on top of {ostack}.

. Download the `SUSE-CaaS-Platform-2.0-OpenStack-Cloud.x86_64-1.0.0-GM.qcow2`
image from link:https://download.suse.com/Download?buildid=tW8sXCIHrWE~
({scc} account required).

. Upload the {caaspa} 2 image to {ostack}:
+
[source,bash]
----
$ openstack image create \
  --file SUSE-CaaS-Platform-2.0-OpenStack-Cloud.x86_64-1.0.0-GM.qcow2 \
  SUSE-CaaS-Platform-2.0-GM
----

. Create a additional security group with rules needed for {product}
+
[source,bash]
----
$ openstack security group create cap --description "Allow CAP traffic"
$ openstack security group rule create cap --protocol any --dst-port any --ethertype IPv4 --egress
$ openstack security group rule create cap --protocol any --dst-port any --ethertype IPv6 --egress
$ openstack security group rule create cap --protocol tcp --dst-port 20000:20008 --remote-ip 0.0.0.0/0
$ openstack security group rule create cap --protocol tcp --dst-port 443:443 --remote-ip 0.0.0.0/0
$ openstack security group rule create cap --protocol tcp --dst-port 2793:2793 --remote-ip 0.0.0.0/0
$ openstack security group rule create cap --protocol tcp --dst-port 4443:4443 --remote-ip 0.0.0.0/0
$ openstack security group rule create cap --protocol tcp --dst-port 80:80 --remote-ip 0.0.0.0/0
$ openstack security group rule create cap --protocol tcp --dst-port 2222:2222 --remote-ip 0.0.0.0/0
----

. Clone the Terraform script
+
[source,bash]
----
$ git clone git@github.com:kubic-project/automation.git
$ cd automation/caasp-openstack-terraform
----

. Edit `openstack.tfvars`. Use the names of the just created {ostack} objects,
for example:
+
[source,bash]
----
image_name = "SUSE-CaaS-Platform-2.0-GM"
internal_net = "caasp-net"
external_net = "floating"
admin_size = "m1.large"
master_size = "m1.large"
masters = 1
worker_size = "m1.xlarge"
workers = 2
----

. Initialize Terraform:
+
[source,bash]
----
$ terraform init
----

[id='sec.caasp.deploy']
==== Deploy CaaS Platform

* Source the openrc.sh file, set the project and deploy
+
[source,bash]
----
$ . openrc.sh
$ export OS_PROJECT_NAME='caasp'
$ ./caasp-openstack apply
----
+
* Wait for 5 - 10 minutes until all systems are up and running
* Get an overview of your CaaS Platform installation
+
[source,bash]
----
$ openstack server list
----
+
* Add the initial created `cap` security group to all {product} workers
+
[source,bash]
----
$ openstack server add security group caasp-worker0 cap
$ openstack server add security group caasp-worker1 cap
----

* Access to CaaS Platform nodes
+
For {product} you might have to log into the CaaS Platform master and nodes. To do so,
use ssh with the ssh key in the `automation/caasp-openstack-terraform/ssh`
dir to login as root.


[id='sec.caasp.bootstrap']
==== Bootstrap CaaS Platform

. Point your browser at the IP of the {caaspa} admin node
. Create a new admin user
. On _Initial CaaS Platform Configuration_
  . _Admin node_: Replace the initial value (_public/floating IP_) with
  internal {ostack} {caaspa} subnet IP of the {caaspa} admin node
  . Enable the _Install Tiller_ checkbox.
. On `Bootstrap your CaaS Platform`
  . Click _Next_
. On _Select nodes and roles_
  . Click _Accept All nodes_ and wait until they appear in the upper part of the page
  . Define master and nodes
  . Click _Next_
. On _Confirm bootstrap_
  . _External Kubernetes API FQDN_: Specify the public (floating) IP from
  the {caaspa} master and add the `.xip.io` domain suffix
  . _External Dashboard FQDN_: Specify the public (floating) IP from the
  {caaspa} admin and add the `.xip.io` domain suffix


[id='sec.caasp.prepare-combine']
==== Prepare {caaspa} for {product}

NOTE: You can run commands on multiple nodes using Salt on the admin node.

Access it by logging in to the admin node and than enter the Salt master
container:

[source,bash]
----
$ docker exec -ti `docker ps -q --filter name=salt-master` /bin/bash
----

There you can execute commands using Salt. For executing the same command on
all worker nodes use a command like:

[source,bash]
----
$ salt -P "roles:(kube-minion)" cmd.run 'echo "hello"'
----

This gets you full access to all aspects of the nodes so be careful with what
commands you run.


[id='sec.caasp.root-file-system']
===== Growing the Root File System

Commands to run on the {caaspa} worker nodes

Resize your root file system of the worker to match the disk provided by
{ostack}:

[source,bash]
----
$ growpart /dev/vda 3
$ btrfs filesystem resize max /.snapshots
----


[id='sec.caasp.hostpath']
===== Setting Up Hostpath As the Storage Class

WARNING: Setting Hostpath as the storage class is useful in demonstration
environments only. It is not usable in a production environment.
For example, {product} cannot be updated with a Hostpath setup.

* Commands to run on the {caaspa} master:
+
First edit `/etc/kubernetes/controller-manager` and add the
`--enable-hostpath-provisioner` option there.
+
Then run the following commands:
+
[source,bash]
----
$ mkdir -p /tmp/hostpath_pv
$ chmod a+rwx /tmp/hostpath_pv
$ systemctl restart kube-controller-manager.service
----

* Commands to run on the {caaspa} worker nodes
+
[source,bash]
----
$ mkdir -p /tmp/hostpath_pv
$ chmod a+rwx /tmp/hostpath_pv
----
